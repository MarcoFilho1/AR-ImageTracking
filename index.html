<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MindAR Debug</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="./libs/mindar-image.prod.js"></script>
  <script src="./libs/mindar-image-aframe.prod.js"></script>
  <style>
    body{margin:0;overflow:hidden}
    a-scene{position:fixed;inset:0}
    #ui{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);color:#fff;font-family:system-ui}
    #log{position:fixed;left:8px;right:8px;bottom:8px;background:rgba(0,0,0,.7);color:#0f0;font:12px monospace;padding:8px;max-height:45%;overflow:auto;white-space:pre-wrap}
    button{padding:12px 16px;border:0;border-radius:10px}
  </style>
</head>
<body>
  <div id="ui">
    <div>
      <h3>Toque em Start para iniciar</h3>
      <button id="startBtn" disabled>Start</button>
    </div>
  </div>
  <div id="log"></div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded>
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    <a-entity mindar-image-target="targetIndex: 0">
      <a-box depth="0.05" width="1" height="0.6"
             material="opacity:.8;transparent:true;color:#39f"></a-box>
      <a-text value="FOUND!" align="center" position="0 0.4 0.03"></a-text>
    </a-entity>
  </a-scene>

  <script>
    const logEl = document.getElementById('log');
    const log = (m)=>{ console.log(m); logEl.textContent += (typeof m==='string'?m:JSON.stringify(m))+"\n"; }
    const scene = document.querySelector('a-scene');
    const btn = document.getElementById('startBtn');

    // Habilita o botão apenas quando o componente estiver montado
    scene.addEventListener('loaded', ()=>{
      const comps = Object.keys(scene.components||{});
      log('a-scene loaded. Components: '+comps.join(', '));
      if (scene.components['mindar-image']) {
        log('mindar-image montado');
        btn.disabled = false;
      } else {
        log(' mindar-image NÃO montou (ver ordem dos scripts)');
      }
    });

    // Eventos do MindAR
    scene.addEventListener('arReady', ()=>log('arReady'));
    scene.addEventListener('arError', e=>log('arError: '+(e?.detail?.message||'')));
    scene.addEventListener('targetFound', e=>log(' targetFound '+JSON.stringify(e.detail)));
    scene.addEventListener('targetLost', e=>log('targetLost '+JSON.stringify(e.detail)));

    btn.addEventListener('click', async ()=>{
      log('?? botão clicado');
      try {
        const res = await fetch('./targets.mind', {method:'HEAD'});
        log('HEAD ./targets.mind ? '+res.status);
        if (!res.ok) { log('? targets.mind não encontrado/caminho errado'); return; }

        // Start MindAR
        await scene.components['mindar-image'].start();
        document.getElementById('ui').style.display='none';
        log('câmera iniciada');
      } catch (e) {
        log('start() falhou: '+(e.stack||e));
      }
    });
  </script>
</body>
</html>
